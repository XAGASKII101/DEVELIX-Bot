import { storage } from './storage';
import pino from 'pino';

const logger = pino({ level: 'info' });

interface BotState {
  currentMenu: string;
  leadFormStep: number;
  leadData: any;
}

const userStates = new Map<string, BotState>();

export async function handleMessage(sock: any, message: any) {
  const phoneNumber = message.key.remoteJid;
  const messageText = message.message?.conversation || 
                     message.message?.extendedTextMessage?.text || '';
  
  if (!messageText) return;

  // Store the received message
  await storage.createBotMessage({
    phoneNumber,
    messageType: 'received',
    content: messageText,
    isBot: 0,
  });

  const userState = userStates.get(phoneNumber) || {
    currentMenu: 'main',
    leadFormStep: 0,
    leadData: {}
  };

  let responseMessage = '';

  // Handle different states and commands
  if (userState.currentMenu === 'lead_form') {
    responseMessage = await handleLeadForm(phoneNumber, messageText, userState);
  } else {
    responseMessage = await handleMainMenu(phoneNumber, messageText, userState);
  }

  // Update user state
  userStates.set(phoneNumber, userState);

  // Send response
  if (responseMessage) {
    await sock.sendMessage(phoneNumber, { text: responseMessage });
    
    // Store the sent message
    await storage.createBotMessage({
      phoneNumber,
      messageType: 'sent',
      content: responseMessage,
      isBot: 1,
    });
  }
}

async function handleMainMenu(phoneNumber: string, messageText: string, userState: BotState): Promise<string> {
  const input = messageText.trim().toLowerCase();

  // Handle numbered menu options
  switch (input) {
    case '1':
    case 'custom':
    case 'custom development':
    case 'development':
    case 'dev':
      return getCustomDevelopmentInfo(userState);
    case '2':
    case 'products':
    case 'product':
    case 'apps':
    case 'app':
      return getProductsInfo();
    case '3':
    case 'ai':
    case 'artificial intelligence':
    case 'ml':
    case 'machine learning':
      return getAIInfo();
    case '4':
    case 'web':
    case 'website':
    case 'web development':
    case 'web dev':
      return getWebDevInfo();
    case '5':
    case 'blockchain':
    case 'elixa':
    case 'crypto':
    case 'defi':
      return getBlockchainInfo();
    case '6':
    case 'vendra':
    case 'marketplace':
      return getVendraInfo();
    case '7':
    case 'portfolio':
    case 'showcase':
    case 'projects':
    case 'case studies':
      return getPortfolioInfo();
    case '8':
    case 'quote':
    case 'quotes':
    case 'qoute':
    case 'qotw':
    case 'consultation':
    case 'consult':
    case 'estimate':
      return getQuoteInfo(userState);
    case '9':
    case 'contact':
    case 'support':
    case 'help':
    case 'reach':
      return getContactInfo();
    case 'menu':
    case 'start':
    case 'main':
    case 'home':
      return getMainMenu();
    default:
      // Handle keyword matching for more flexibility
      if (input.includes('project') || input.includes('quote') || input.includes('qoute') || 
          input.includes('development') || input.includes('estimate') || input.includes('consult')) {
        return getQuoteInfo(userState);
      }
      if (input.includes('ai') || input.includes('artificial') || input.includes('machine')) {
        return getAIInfo();
      }
      if (input.includes('web') || input.includes('website')) {
        return getWebDevInfo();
      }
      if (input.includes('blockchain') || input.includes('crypto') || input.includes('elixa')) {
        return getBlockchainInfo();
      }
      if (input.includes('vendra') || input.includes('marketplace')) {
        return getVendraInfo();
      }
      if (input.includes('portfolio') || input.includes('showcase') || input.includes('case')) {
        return getPortfolioInfo();
      }
      if (input.includes('contact') || input.includes('support') || input.includes('reach')) {
        return getContactInfo();
      }
      if (input.includes('product') || input.includes('app')) {
        return getProductsInfo();
      }
      return getMainMenu();
  }
}

async function handleLeadForm(phoneNumber: string, messageText: string, userState: BotState): Promise<string> {
  const input = messageText.trim();
  const lowerInput = input.toLowerCase();

  // Allow users to exit lead form and return to menu
  if (lowerInput === 'menu' || lowerInput === 'cancel' || lowerInput === 'exit' || lowerInput === 'back') {
    userState.currentMenu = 'main';
    userState.leadFormStep = 0;
    userState.leadData = {};
    return getMainMenu();
  }

  switch (userState.leadFormStep) {
    case 1: // Project type
      userState.leadData.projectType = input;
      userState.leadFormStep = 2;
      return "üí∞ What's your budget range?\n\n1. ‚Ç¶100K - ‚Ç¶500K\n2. ‚Ç¶500K - ‚Ç¶1M\n3. ‚Ç¶1M - ‚Ç¶3M\n4. ‚Ç¶3M - ‚Ç¶5M\n5. ‚Ç¶5M+\n\nPlease type the number or your budget range:";
    
    case 2: // Budget
      const budgetOptions = {
        '1': '‚Ç¶100K - ‚Ç¶500K',
        '2': '‚Ç¶500K - ‚Ç¶1M',
        '3': '‚Ç¶1M - ‚Ç¶3M',
        '4': '‚Ç¶3M - ‚Ç¶5M',
        '5': '‚Ç¶5M+'
      };
      userState.leadData.budget = budgetOptions[input as keyof typeof budgetOptions] || input;
      userState.leadFormStep = 3;
      return "‚è∞ What's your timeline?\n\n1. ASAP (Rush)\n2. 1-3 months\n3. 3-6 months\n4. 6+ months\n\nPlease type the number or your timeline:";
    
    case 3: // Timeline
      const timelineOptions = {
        '1': 'ASAP (Rush)',
        '2': '1-3 months',
        '3': '3-6 months',
        '4': '6+ months'
      };
      userState.leadData.timeline = timelineOptions[input as keyof typeof timelineOptions] || input;
      userState.leadFormStep = 4;
      return "üìù Please provide a brief description of your project and any specific requirements:";
    
    case 4: // Description
      userState.leadData.description = input;
      userState.leadFormStep = 5;
      return "üë§ What's your name? (This helps us personalize our service)";
    
    case 5: // Name
      userState.leadData.name = input;
      
      // Save the lead
      await storage.createLead({
        phoneNumber,
        name: userState.leadData.name,
        projectType: userState.leadData.projectType,
        budget: userState.leadData.budget,
        timeline: userState.leadData.timeline,
        description: userState.leadData.description,
        status: 'new'
      });

      // Reset state
      userState.currentMenu = 'main';
      userState.leadFormStep = 0;
      userState.leadData = {};

      return `üéâ Thank you ${userState.leadData.name}! Your project inquiry has been submitted.\n\nüìã Summary:\n‚Ä¢ Project: ${userState.leadData.projectType}\n‚Ä¢ Budget: ${userState.leadData.budget}\n‚Ä¢ Timeline: ${userState.leadData.timeline}\n\n‚úÖ Our team will review your requirements and contact you within 24 hours with a detailed proposal.\n\nüìû For urgent matters, call us directly at +234 810 751 6059\n\nType 'menu' to return to the main menu.`;
    
    default:
      userState.currentMenu = 'main';
      userState.leadFormStep = 0;
      return getMainMenu();
  }
}

function getMainMenu(): string {
  return `üëã *Welcome to Develix!*

üöÄ *Technology Without Barriers*
AI & Software solutions built in Nigeria, designed for the world.

Please select from the menu below:

1Ô∏è‚É£ *Custom Development* - Bring Your Ideas to Life
2Ô∏è‚É£ *Our Products & Apps* - Ready-to-use Solutions  
3Ô∏è‚É£ *AI Models & Solutions* - Machine Learning Services
4Ô∏è‚É£ *Website Development* - Modern Web Solutions
5Ô∏è‚É£ *Elixa Coin & Blockchain* - DeFi & Crypto Solutions
6Ô∏è‚É£ *Vendra Marketplace* - AI-Powered Business Tools
7Ô∏è‚É£ *Project Showcase* - Case Studies & Portfolio
8Ô∏è‚É£ *Get Quote/Consultation* - Free Project Assessment
9Ô∏è‚É£ *Contact & Support* - Get in Touch

üí° *How to use:*
‚Ä¢ Type a number (1-9)
‚Ä¢ Use keywords like "quote", "ai", "web", "vendra"
‚Ä¢ Type "menu" anytime to return here`;
}

function getCustomDevelopmentInfo(userState: BotState): string {
  return `üõ†Ô∏è *Custom Development Services*

We build custom software solutions tailored to your specific needs:

üíª *Our Services:*
‚Ä¢ *Mobile Apps:* React Native, Flutter (‚Ç¶500K - ‚Ç¶2M)
‚Ä¢ *Web Applications:* React, Next.js, Node.js (‚Ç¶300K - ‚Ç¶1.5M)  
‚Ä¢ *AI/ML Solutions:* Custom models, API integration (‚Ç¶800K - ‚Ç¶3M)
‚Ä¢ *Enterprise Systems:* CRM, ERP, Dashboard (‚Ç¶1M - ‚Ç¶5M)

‚≠ê *Recent Success:* FirstBank Nigeria - 300% transaction speed improvement

üìä *Our Track Record:*
‚Ä¢ 98% client satisfaction rate
‚Ä¢ 150+ projects delivered
‚Ä¢ $50M+ client ROI generated

Would you like to discuss your project? Reply with 'quote' to start!`;
}

function getProductsInfo(): string {
  return `üì± *Our Ready-to-Use Products*

Explore our collection of innovative apps and solutions:

üè™ *Vendra* - AI-Powered SME Platform
‚Ä¢ ‚ÇÇ2.5M total supply
‚Ä¢ Multilingual marketplace for African SMEs
‚Ä¢ AI customer engagement tools

ü™ô *Elixa Coin* - Blockchain & DeFi  
‚Ä¢ ‚Ç¶850 current price
‚Ä¢ 15K+ token holders, 99.9% uptime
‚Ä¢ Africa's gateway to decentralized finance

üõ°Ô∏è *Anti-Fraud Detector* - AI Security System
‚Ä¢ Real-time fraud detection with 95% accuracy
‚Ä¢ Used by major banks across Nigeria

ü§ñ *WhatsApp Bot* - This bot you're using!
‚Ä¢ Automated customer service
‚Ä¢ Smart lead generation
‚Ä¢ 24/7 availability

Type the product name for more details or 'menu' for main menu.`;
}

function getAIInfo(): string {
  return `ü§ñ *AI Models & Machine Learning*

Advanced AI solutions powered by cutting-edge technology:

üó£Ô∏è *Natural Language Processing*
‚Ä¢ Multilingual support: English, Hausa, Yoruba, Igbo, Swahili
‚Ä¢ Sentiment analysis and text classification
‚Ä¢ Chatbot development

üëÅÔ∏è *Computer Vision*  
‚Ä¢ Medical imaging analysis
‚Ä¢ Document processing and OCR
‚Ä¢ Object detection and recognition

üìä *Predictive Analytics*
‚Ä¢ Financial forecasting and risk assessment  
‚Ä¢ Market analysis and customer insights
‚Ä¢ Business intelligence dashboards

üèÜ *Success Stories:*
‚Ä¢ Kuda Bank: 95% fraud reduction with our ML model
‚Ä¢ LUTH: 60% faster patient diagnosis with AI
‚Ä¢ 15+ enterprises using our AI solutions

Ready to explore AI for your business? Type '8' for consultation!`;
}

function getWebDevInfo(): string {
  return `üåê *Modern Website Development*

Professional websites that drive results:

üìä *Our Metrics:*
‚Ä¢ 99.9% Uptime SLA
‚Ä¢ 2-8 Week Delivery  
‚Ä¢ Mobile-first approach

üí∞ *Pricing:*
‚Ä¢ *Business Websites:* ‚Ç¶150K - ‚Ç¶500K
‚Ä¢ *E-commerce Platforms:* ‚Ç¶400K - ‚Ç¶1.2M
‚Ä¢ *Web Applications:* ‚Ç¶600K - ‚Ç¶2M
‚Ä¢ *Enterprise Portals:* ‚Ç¶1M - ‚Ç¶5M

üõ†Ô∏è *Technology Stack:*
React ‚Ä¢ Next.js ‚Ä¢ Node.js ‚Ä¢ AWS ‚Ä¢ Docker

‚úÖ *What's Included:*
‚Ä¢ Responsive design for all devices
‚Ä¢ SEO optimization  
‚Ä¢ Security implementation
‚Ä¢ Performance optimization
‚Ä¢ 6 months free maintenance

Ready to start your web project? Type '8' for a free quote!`;
}

function getBlockchainInfo(): string {
  return `‚õìÔ∏è *Elixa Coin & Blockchain Solutions*

Africa's gateway to decentralized finance:

üìà *Live Metrics:*
‚Ä¢ 2.5M Total Supply (Fixed)
‚Ä¢ ‚Ç¶850 Current Price
‚Ä¢ 15K+ Token Holders  
‚Ä¢ 99.9% Network Uptime

üí∞ *Key Benefits:*
‚Ä¢ *Cross-Border Payments:* <1% fees vs 8-12% traditional
‚Ä¢ *DeFi Savings:* Up to 12% APY staking rewards
‚Ä¢ *Merchant Integration:* Instant crypto payments

üèóÔ∏è *Blockchain Services:*
‚Ä¢ Smart Contract Development
‚Ä¢ DeFi Protocol Creation  
‚Ä¢ Cryptocurrency Integration
‚Ä¢ NFT Marketplace Development

üîí *Security & Compliance:*
‚Ä¢ Audited by leading blockchain security firms
‚Ä¢ Fully compliant with Nigerian SEC
‚Ä¢ Built on Polygon for scalability

Get ELX tokens or learn more? Type 'elixa' for details!`;
}

function getVendraInfo(): string {
  return `üè™ *Vendra - AI-Powered SME Platform*

Empowering African small businesses with smart tools:

üìä *Live Marketplace Metrics:*
‚Ä¢ ‚Ç¶42.3M 24h Sales Volume (+22.1%)
‚Ä¢ 2,314 Active Vendors
‚Ä¢ 96% Order Fulfillment Rate
‚Ä¢ 4.7‚òÖ Customer Rating

üöÄ *Key Features:*
‚Ä¢ *Multilingual AI:* English, Hausa, Yoruba, Igbo, Swahili, French
‚Ä¢ *Mobile-First:* Works on 2G networks, offline processing  
‚Ä¢ *Smart Analytics:* Sales forecasting, customer insights
‚Ä¢ *Social Commerce:* WhatsApp/Instagram integration

üí≥ *Payment Options:*
‚Ä¢ Mobile money (M-Pesa, Airtel Money)
‚Ä¢ Bank transfers
‚Ä¢ Cryptocurrency payments
‚Ä¢ Instant settlement

üéØ *Perfect For:*
‚Ä¢ Small retailers and vendors
‚Ä¢ Service providers
‚Ä¢ E-commerce businesses
‚Ä¢ Social media sellers

Start your free trial? Type 'vendra' for access!`;
}

function getPortfolioInfo(): string {
  return `üèÜ *Our Success Stories*

Proven track record of delivering exceptional results:

üìä *Company Metrics:*
‚Ä¢ 150+ Projects Completed
‚Ä¢ 98% Client Satisfaction
‚Ä¢ $50M+ Client ROI Generated

üè¶ *Featured Case Studies:*

*FirstBank Nigeria* - Digital Transformation
‚Ä¢ 300% transaction speed improvement
‚Ä¢ $12M operational savings
‚Ä¢ 6-month implementation

*Kuda Bank* - AI Fraud Detection  
‚Ä¢ 95% fraud reduction
‚Ä¢ $25M losses prevented
‚Ä¢ 4-month development

*LUTH Hospital* - Patient Management
‚Ä¢ 60% faster diagnosis
‚Ä¢ $2.5M cost savings
‚Ä¢ AI-powered system

üéØ *Industries We Serve:*
‚Ä¢ FinTech & Banking
‚Ä¢ Healthcare
‚Ä¢ E-commerce
‚Ä¢ Government
‚Ä¢ Education

View detailed case studies? Type 'portfolio' for full showcase!`;
}

function getQuoteInfo(userState: BotState): string {
  userState.currentMenu = 'lead_form';
  userState.leadFormStep = 1;
  
  return `üí° *Get Your Free Consultation*

Let's discuss your project and provide a detailed quote:

üéØ *What You'll Get:*
‚úÖ Detailed project analysis & requirements
‚úÖ Technology recommendations  
‚úÖ Accurate timeline & budget estimate
‚úÖ 30-minute strategy call with our founders

üìù *Quick Project Assessment:*

What type of project do you need?

1. Mobile App Development
2. Website Development  
3. AI/ML Solution
4. Blockchain Integration
5. Enterprise System
6. Other (please specify)

Please type the number or describe your project:`;
}

function getContactInfo(): string {
  return `üìû *Get in Touch*

Multiple ways to connect with our team:

üì± *WhatsApp Direct:* +234 810 751 6059
‚úâÔ∏è *Email:* hello@develix.com  
üåê *Website:* www.develix.com

üë®‚Äçüíª *Meet Our Founders:*
‚Ä¢ *Alexius Dubem (17)* - CEO & Co-Founder
‚Ä¢ *Jerome Ebube (16)* - CTO & Co-Founder
üá≥üá¨ Built in Anambra State, Nigeria

üïí *Business Hours:*
Monday - Friday: 9:00 AM - 6:00 PM (WAT)
Emergency support: 24/7 available

üéØ *Office Location:*
Anambra State, Nigeria

Ready to schedule a meeting? Type '8' for consultation booking!`;
}
